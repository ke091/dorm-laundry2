<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ComfortLink ì„¸íƒ ì‹œìŠ¤í…œ</title>

<style>
body{font-family:Arial;background:#f0f2f5;padding:15px}
h1{text-align:center}
h2{margin-top:20px}

.dashboard{background:#fff;padding:15px;border-radius:12px;margin-bottom:15px}

.machine{
  background:#fff;
  padding:15px;
  margin:10px 0;
  border-radius:12px;
  position:relative;
}

.available{border-left:8px solid #4caf50}
.using{border-left:8px solid #ff9800}
.finished{border-left:8px solid #f44336}

button{
  margin:6px 4px;
  padding:10px 14px;
  font-size:15px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.start{background:#4caf50;color:#fff}
.reserve{background:#2196f3;color:#fff}
.finish{background:#ff5722;color:#fff}
.extend{background:#009688;color:#fff}
.clean{background:#9c27b0;color:#fff}
.request{background:#e91e63;color:#fff}
.cancel{background:#777;color:#fff}

.favorite{
  position:absolute;
  top:10px;
  right:12px;
  font-size:22px;
  cursor:pointer;
}
.star-on{color:#ffc107}
.star-off{color:#bbb}

.time{font-weight:bold;font-size:16px}
small{color:#555}
</style>
</head>

<body>

<h1>ğŸ§º ComfortLink ì„¸íƒ ì‹œìŠ¤í…œ</h1>

<div class="dashboard" id="dashboard"></div>
<div id="favorites"></div>
<div id="app"></div>

<script>
// ================= ë°© ë²ˆí˜¸ =================
let myRoom = localStorage.getItem("room");
let usedRooms = JSON.parse(localStorage.getItem("usedRooms")||"[]");

if(!myRoom){
  while(true){
    let input = prompt("ë°© ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 203í˜¸)");
    if(!input) continue;
    let r = input.replace(/[^0-9]/g,"");
    if(usedRooms.includes(r)){
      alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë°© ë²ˆí˜¸ì…ë‹ˆë‹¤");
    }else{
      myRoom = r;
      usedRooms.push(r);
      localStorage.setItem("usedRooms",JSON.stringify(usedRooms));
      localStorage.setItem("room",myRoom);
      break;
    }
  }
}

// ================= ì¦ê²¨ì°¾ê¸° =================
let favorites = JSON.parse(localStorage.getItem("favorites")||"[]");

// ================= ê¸°ê¸° =================
let machines = JSON.parse(localStorage.getItem("machines")) || [
{id:1,floor:1,name:"ì„¸íƒê¸° 1"},
{id:2,floor:1,name:"ê±´ì¡°ê¸° 1"},
{id:3,floor:2,name:"ì„¸íƒê¸° 1"},
{id:4,floor:2,name:"ì„¸íƒê¸° 2"},
{id:5,floor:2,name:"ê±´ì¡°ê¸° 1"},
{id:6,floor:2,name:"ê±´ì¡°ê¸° 2"},
{id:7,floor:3,name:"ì„¸íƒê¸° 1"},
{id:8,floor:3,name:"ì„¸íƒê¸° 2"},
{id:9,floor:3,name:"ê±´ì¡°ê¸° 1"},
{id:10,floor:3,name:"ê±´ì¡°ê¸° 2"}
].map(m=>({
  ...m,
  status:m.status||"available",
  room:m.room||null,
  endTime:m.endTime||null,
  reservations:m.reservations||[],
  alerted:false
}));

// ================= ì‹œê°„ =================
function remain(m){
  return Math.max(0, Math.ceil((m.endTime - Date.now())/60000));
}

function parseTime(input){
  input=input.replace(/\s/g,"");
  if(input.includes(":")){
    let [h,m]=input.split(":").map(Number);
    return h*60+(m||0);
  }
  let h=input.match(/(\d+)ì‹œê°„/);
  let m=input.match(/(\d+)ë¶„/);
  return (h?+h[1]*60:0)+(m?+m[1]:0);
}

// ================= ëŒ€ì‹œë³´ë“œ =================
function dashboard(){
  let using = machines.find(m=>m.room==myRoom && m.status=="using");
  let reserving = machines.find(m=>m.reservations.includes(myRoom));

  document.getElementById("dashboard").innerHTML=`
  <strong>${myRoom}í˜¸</strong><br>
  ì‚¬ìš©ì¤‘: ${using? using.floor+"ì¸µ "+using.name+" ("+remain(using)+"ë¶„)": "ì—†ìŒ"}<br>
  ì˜ˆì•½: ${reserving? reserving.floor+"ì¸µ "+reserving.name:"ì—†ìŒ"}
  `;
}

// ================= ì¹´ë“œ HTML =================
function machineHTML(m){
  let starOn = favorites.includes(m.id);
  let html=`<div class="machine ${m.status}">
    <div class="favorite ${starOn?"star-on":"star-off"}"
      onclick="toggleFav(${m.id})">${starOn?"â­":"â˜†"}</div>

    <strong>${m.floor}ì¸µ ${m.name}</strong><br>`;

  if(m.status=="available"){
    html+=`
    ğŸŸ¢ ì‚¬ìš© ê°€ëŠ¥<br>
    <button class="start" onclick="start(${m.id})">ì‚¬ìš© ì‹œì‘</button>
    <button class="reserve" onclick="reserve(${m.id})">ì˜ˆì•½</button>`;
  }

  if(m.status=="using"){
    html+=`
    ğŸŸ  ${m.room}í˜¸ ì‚¬ìš©ì¤‘<br>
    â° <span class="time">${remain(m)}ë¶„</span><br>
    <button class="reserve" onclick="reserve(${m.id})">ì˜ˆì•½</button>`;

    if(m.room==myRoom){
      html+=`
      <button class="extend" onclick="extendTime(${m.id})">ì‹œê°„ ì—°ì¥</button>
      <button class="finish" onclick="finish(${m.id})">ì‚¬ìš© ì¢…ë£Œ</button>`;
    }else{
      html+=`
      <button class="request" onclick="requestClean(${m.id})">ì •ë¦¬ ìš”ì²­</button>`;
    }

    if(remain(m)<=5 && !m.alerted && m.room==myRoom){
      alert("â° 5ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤!");
      m.alerted=true;
    }

    if(remain(m)==0){
      m.status="finished";
      if(m.room==myRoom) alert("ğŸ”” ì‚¬ìš©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤");
    }
  }

  if(m.status=="finished"){
    html+=`
    ğŸ”´ ì‚¬ìš© ì™„ë£Œ (${m.room}í˜¸)<br>
    <button class="clean" onclick="clearMachine(${m.id})">ì •ë¦¬ ì™„ë£Œ</button>`;
    if(m.room!=myRoom){
      html+=`<button class="request" onclick="requestClean(${m.id})">ì •ë¦¬ ìš”ì²­</button>`;
    }
  }

  if(m.reservations.length){
    html+=`<small>ì˜ˆì•½: ${m.reservations.join(", ")}í˜¸</small>`;
    if(m.reservations.includes(myRoom)){
      html+=`<br><button class="cancel" onclick="cancelReserve(${m.id})">ì˜ˆì•½ ì·¨ì†Œ</button>`;
    }
  }

  html+=`</div>`;
  return html;
}

// ================= ë Œë” =================
function render(){
  dashboard();
  localStorage.setItem("machines",JSON.stringify(machines));
  localStorage.setItem("favorites",JSON.stringify(favorites));

  const favBox=document.getElementById("favorites");
  const app=document.getElementById("app");
  favBox.innerHTML="";
  app.innerHTML="";

  if(favorites.length){
    favBox.innerHTML="<h2>â­ ì¦ê²¨ì°¾ê¸°</h2>";
    machines.filter(m=>favorites.includes(m.id)).forEach(m=>{
      favBox.innerHTML+=machineHTML(m);
    });
  }

  [1,2,3].forEach(f=>{
    app.innerHTML+=`<h2>${f}ì¸µ</h2>`;
    machines.filter(m=>m.floor==f).forEach(m=>{
      app.innerHTML+=machineHTML(m);
    });
  });
}

// ================= ê¸°ëŠ¥ =================
function toggleFav(id){
  favorites.includes(id)
    ? favorites=favorites.filter(f=>f!=id)
    : favorites.push(id);
}

function start(id){
  if(machines.some(m=>m.room==myRoom && m.status=="using"))
    return alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê¸°ê¸°ê°€ ìˆìŠµë‹ˆë‹¤");

  let t=parseTime(prompt("ì‚¬ìš© ì‹œê°„ ì…ë ¥"));
  if(!t) return alert("ì‹œê°„ ì˜¤ë¥˜");

  let m=machines.find(x=>x.id==id);
  m.status="using";
  m.room=myRoom;
  m.endTime=Date.now()+t*60000;
  m.alerted=false;
}

function extendTime(id){
  let t=parseTime(prompt("ì—°ì¥ ì‹œê°„ ì…ë ¥"));
  if(!t) return;
  machines.find(x=>x.id==id).endTime+=t*60000;
}

function reserve(id){
  if(machines.some(m=>m.reservations.includes(myRoom)))
    return alert("ì´ë¯¸ ì˜ˆì•½ ì¤‘ì…ë‹ˆë‹¤");
  machines.find(x=>x.id==id).reservations.push(myRoom);
}

function cancelReserve(id){
  let m=machines.find(x=>x.id==id);
  m.reservations=m.reservations.filter(r=>r!=myRoom);
}

function finish(id){
  machines.find(x=>x.id==id).status="finished";
}

function clearMachine(id){
  let m=machines.find(x=>x.id==id);
  m.status="available";
  m.room=null;
  m.endTime=null;
  m.alerted=false;
}

function requestClean(id){
  alert("ğŸ“¢ ì‚¬ìš© ì¤‘ì¸ ë°©ì— ì •ë¦¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤");
}

setInterval(render,1000);
render();
</script>

</body>
</html>