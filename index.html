<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê¸°ìˆ™ì‚¬ ì„¸íƒê¸° ì‹œìŠ¤í…œ</title>

<style>
body{font-family:Arial;background:#f0f2f5;padding:20px}
h1{text-align:center}
h2{margin-top:25px}
.dashboard{background:#fff;padding:15px;border-radius:10px;margin-bottom:20px}
.machine{background:#fff;padding:15px;margin:10px 0;border-radius:10px}
.available{border-left:8px solid #4caf50}
.using{border-left:8px solid #ff9800}
.finished{border-left:8px solid #f44336}
button{margin:5px;padding:10px 14px;font-size:15px}
small{color:#555}
</style>
</head>

<body>

<h1>ğŸ§º ê¸°ìˆ™ì‚¬ ì„¸íƒê¸° / ê±´ì¡°ê¸° ì‹œìŠ¤í…œ</h1>
<div class="dashboard" id="dashboard"></div>
<div id="app"></div>

<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyALbv48xEDyGtdaNn8MCvF79bqDmEKjjf0",
  authDomain: "comfortlink-laundry.firebaseapp.com",
  projectId: "comfortlink-laundry"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);
const machinesRef = doc(db, "shared", "machines");
/* ============================================ */

// ---------------- ì‚¬ìš©ì ë°© ë²ˆí˜¸ ----------------
let myRoom = localStorage.getItem("room");
if(!myRoom){
  let input = prompt("ë°© ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 203í˜¸)");
  myRoom = input.replace(/[^0-9]/g,"");
  localStorage.setItem("room", myRoom);
}

// ---------------- ê¸°ê¸° ì •ë³´ ----------------
let machines = [
{id:1,floor:1,name:'ì„¸íƒê¸° 1'},
{id:2,floor:1,name:'ê±´ì¡°ê¸° 1'},
{id:3,floor:2,name:'ì„¸íƒê¸° 1'},
{id:4,floor:2,name:'ì„¸íƒê¸° 2'},
{id:5,floor:2,name:'ê±´ì¡°ê¸° 1'},
{id:6,floor:2,name:'ê±´ì¡°ê¸° 2'},
{id:7,floor:3,name:'ì„¸íƒê¸° 1'},
{id:8,floor:3,name:'ì„¸íƒê¸° 2'},
{id:9,floor:3,name:'ê±´ì¡°ê¸° 1'},
{id:10,floor:3,name:'ê±´ì¡°ê¸° 2'}
];

machines.forEach(m=>{
  m.status="available";
  m.room=null;
  m.endTime=null;
  m.reservations=[];
  m.alert5=false;
});

// ---------------- Firestore ì´ˆê¸°í™” ----------------
await setDoc(machinesRef, { machines }, { merge:true });

// ---------------- ì‹¤ì‹œê°„ ìˆ˜ì‹  ----------------
onSnapshot(machinesRef, snap=>{
  if(snap.exists()){
    machines = snap.data().machines;
    render();
  }
});

// ---------------- Firestore ì €ì¥ ----------------
function save(){
  updateDoc(machinesRef, { machines });
}

// ---------------- ê³µí†µ í•¨ìˆ˜ ----------------
function remain(m){
  return Math.max(0, Math.ceil((m.endTime - Date.now()) / 60000));
}

// ---------------- ëŒ€ì‹œë³´ë“œ ----------------
function dashboard(){
  let using = machines.find(m=>m.room==myRoom && m.status=="using");
  let reserving = machines.find(m=>m.reservations.includes(myRoom));

  document.getElementById("dashboard").innerHTML=`
    <strong>ë‚´ ë°©: ${myRoom}í˜¸</strong><br>
    ì‚¬ìš© ì¤‘: ${using ? using.floor+'ì¸µ '+using.name+' ('+remain(using)+'ë¶„ ë‚¨ìŒ)' : 'ì—†ìŒ'}<br>
    ì˜ˆì•½: ${reserving ? reserving.floor+'ì¸µ '+reserving.name : 'ì—†ìŒ'}
  `;
}

// ---------------- í™”ë©´ ë Œë” ----------------
function render(){
  dashboard();
  const app=document.getElementById("app");
  app.innerHTML="";

  [1,2,3].forEach(floor=>{
    app.innerHTML+=`<h2>${floor}ì¸µ</h2>`;
    machines.filter(m=>m.floor==floor).forEach(m=>{
      let html=`<div class="machine ${m.status}"><strong>${m.name}</strong><br>`;

      if(m.status=="available"){
        html+=`ğŸŸ¢ ì‚¬ìš© ê°€ëŠ¥<br>
        <button onclick="start(${m.id})">ì‚¬ìš© ì‹œì‘</button>
        <button onclick="reserve(${m.id})">ì˜ˆì•½</button>`;
      }

      if(m.status=="using"){
        html+=`ğŸŸ  ${m.room}í˜¸ ì‚¬ìš© ì¤‘<br>
        â° ${remain(m)}ë¶„ ë‚¨ìŒ<br>
        <button onclick="reserve(${m.id})">ì˜ˆì•½</button>
        ${m.room==myRoom ? `<button onclick="manualFinish(${m.id})">ì‚¬ìš© ì¢…ë£Œ</button>` : ''}`;

        if(remain(m)<=5 && !m.alert5 && m.room==myRoom){
          alert("â° 5ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤!");
          m.alert5=true;
        }
        if(remain(m)==0) autoFinish(m);
      }

      if(m.status=="finished"){
        html+=`ğŸ”´ ì‚¬ìš© ì™„ë£Œ (${m.room}í˜¸)<br>
        <button onclick="clearMachine(${m.id})">ì •ë¦¬ ì™„ë£Œ</button>
        <button onclick="requestClean(${m.id})">ì •ë¦¬ ìš”ì²­</button>`;
      }

      if(m.reservations.length>0){
        html+=`<small>ì˜ˆì•½ ëŒ€ê¸°: ${m.reservations.join(', ')}í˜¸</small>`;
        if(m.reservations.includes(myRoom)){
          html+=`<br><button onclick="cancelReserve(${m.id})">ì˜ˆì•½ ì·¨ì†Œ</button>`;
        }
      }

      html+=`</div>`;
      app.innerHTML+=html;
    });
  });
}

// ---------------- ê¸°ëŠ¥ í•¨ìˆ˜ ----------------
window.start = function(id){
  let t = parseInt(prompt("ì‚¬ìš© ì‹œê°„ (ë¶„)"));
  if(!t) return;

  let m=machines.find(x=>x.id==id);
  m.status="using";
  m.room=myRoom;
  m.endTime=Date.now()+t*60000;
  m.alert5=false;
  save();
}

window.reserve = function(id){
  let m=machines.find(x=>x.id==id);
  if(!m.reservations.includes(myRoom)){
    m.reservations.push(myRoom);
    save();
  }
}

window.cancelReserve = function(id){
  let m=machines.find(x=>x.id==id);
  m.reservations = m.reservations.filter(r=>r!=myRoom);
  save();
}

window.manualFinish = function(id){
  let m=machines.find(x=>x.id==id);
  m.status="finished";
  save();
}

window.autoFinish = function(m){
  m.status="finished";
  save();
}

window.clearMachine = function(id){
  let m=machines.find(x=>x.id==id);
  m.status="available";
  m.room=null;
  m.endTime=null;
  m.alert5=false;

  if(m.reservations.length){
    let next=m.reservations.shift();
    if(next==myRoom) alert("ğŸ“¢ ì˜ˆì•½ ì°¨ë¡€ì…ë‹ˆë‹¤!");
  }
  save();
}

window.requestClean = function(id){
  let m=machines.find(x=>x.id==id);
  alert(`ğŸ“¢ ${m.room}í˜¸ì— ì •ë¦¬ ìš”ì²­ ì „ì†¡ë¨`);
}

setInterval(render,1000);
render();
</script>

</body>
</html>