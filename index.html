<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ComfortLink ì„¸íƒ ì‹œìŠ¤í…œ</title>

<style>
body{font-family:Arial;background:#f0f2f5;padding:15px}
h1{text-align:center}
h2{margin-top:20px}
.dashboard{background:#fff;padding:15px;border-radius:12px;margin-bottom:15px}
.machine{background:#fff;padding:15px;margin:10px 0;border-radius:12px;position:relative}
.available{border-left:8px solid #4caf50}
.using{border-left:8px solid #ff9800}
.finished{border-left:8px solid #f44336}
button{margin:6px 4px;padding:10px 14px;font-size:15px;border:none;border-radius:8px;cursor:pointer}
.start{background:#4caf50;color:#fff}
.reserve{background:#2196f3;color:#fff}
.finish{background:#ff5722;color:#fff}
.extend{background:#009688;color:#fff}
.clean{background:#9c27b0;color:#fff}
.request{background:#e91e63;color:#fff}
.cancel{background:#777;color:#fff}
.favorite{position:absolute;top:10px;right:12px;font-size:22px;cursor:pointer}
.star-on{color:#ffc107}
.star-off{color:#bbb}
.time{font-weight:bold;font-size:16px}
small{color:#555}
</style>
</head>

<body>

<h1>ğŸ§º ComfortLink ì„¸íƒ ì‹œìŠ¤í…œ</h1>
<div class="dashboard" id="dashboard"></div>
<div id="favorites"></div>
<div id="app"></div>

<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyALbv48xEDyGtdaNn8MCvF79bqDmEKjjf0",
  authDomain: "comfortlink-laundry.firebaseapp.com",
  projectId: "comfortlink-laundry",
  storageBucket: "comfortlink-laundry.firebasestorage.app",
  messagingSenderId: "484193931044",
  appId: "1:484193931044:web:fb528955ca8088950c6db1"
};

const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);
const stateRef = doc(db,"state","machines");

/* ================= ë°© ë²ˆí˜¸ ================= */
let myRoom = localStorage.getItem("room");
if(!myRoom){
  myRoom = prompt("ë°© ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 203)").replace(/[^0-9]/g,"");
  localStorage.setItem("room",myRoom);
}

/* ================= ì¦ê²¨ì°¾ê¸° ================= */
let favorites = JSON.parse(localStorage.getItem("favorites")||"[]");

/* ================= ê¸°ê¸° ================= */
let machines = [
{id:1,floor:1,name:"ì„¸íƒê¸° 1"},
{id:2,floor:1,name:"ê±´ì¡°ê¸° 1"},
{id:3,floor:2,name:"ì„¸íƒê¸° 1"},
{id:4,floor:2,name:"ì„¸íƒê¸° 2"},
{id:5,floor:2,name:"ê±´ì¡°ê¸° 1"},
{id:6,floor:2,name:"ê±´ì¡°ê¸° 2"},
{id:7,floor:3,name:"ì„¸íƒê¸° 1"},
{id:8,floor:3,name:"ì„¸íƒê¸° 2"},
{id:9,floor:3,name:"ê±´ì¡°ê¸° 1"},
{id:10,floor:3,name:"ê±´ì¡°ê¸° 2"}
].map(m=>({...m,status:"available",room:null,endTime:null,reservations:[],alerted:false}));

/* ================= Firestore ë™ê¸°í™” ================= */
onSnapshot(stateRef,snap=>{
  if(snap.exists()){
    machines = snap.data().machines;
    render();
  }else{
    save();
  }
});

function save(){
  setDoc(stateRef,{machines});
}

/* ================= ì‹œê°„ ================= */
const remain = m =>
  m.endTime ? Math.max(0,Math.ceil((m.endTime-Date.now())/60000)) : 0;

const parseTime=i=>{
  i=i.replace(/\s/g,"");
  if(i.includes(":")){let[a,b]=i.split(":").map(Number);return a*60+(b||0)}
  let h=i.match(/(\d+)ì‹œê°„/),m=i.match(/(\d+)ë¶„/);
  return (h?+h[1]*60:0)+(m?+m[1]:0);
};

/* ================= ëŒ€ì‹œë³´ë“œ ================= */
function dashboard(){
  let using=machines.find(m=>m.room==myRoom&&m.status=="using");
  let reserving=machines.find(m=>m.reservations.includes(myRoom));
  dashboardEl.innerHTML=`
  <strong>${myRoom}í˜¸</strong><br>
  ì‚¬ìš©ì¤‘: ${using?`${using.floor}ì¸µ ${using.name} (${remain(using)}ë¶„)`:"ì—†ìŒ"}<br>
  ì˜ˆì•½: ${reserving?`${reserving.floor}ì¸µ ${reserving.name}`:"ì—†ìŒ"}
  `;
}

/* ================= UI ================= */
function machineHTML(m){
  let starOn=favorites.includes(m.id);
  let h=`<div class="machine ${m.status}">
  <div class="favorite ${starOn?"star-on":"star-off"}" onclick="toggleFav(${m.id})">${starOn?"â­":"â˜†"}</div>
  <strong>${m.floor}ì¸µ ${m.name}</strong><br>`;

  if(m.status=="available"){
    h+=`ğŸŸ¢ ì‚¬ìš© ê°€ëŠ¥<br>
    <button class="start" onclick="start(${m.id})">ì‚¬ìš© ì‹œì‘</button>
    <button class="reserve" onclick="reserve(${m.id})">ì˜ˆì•½</button>`;
  }

  if(m.status=="using"){
    h+=`ğŸŸ  ${m.room}í˜¸ ì‚¬ìš©ì¤‘<br>
    â° <span class="time">${remain(m)}ë¶„</span><br>`;

    if(m.room==myRoom){
      h+=`<button class="extend" onclick="extendTime(${m.id})">ì‹œê°„ ì—°ì¥</button>
      <button class="finish" onclick="finish(${m.id})">ì‚¬ìš© ì¢…ë£Œ</button>`;
    }else{
      h+=`<button class="request" onclick="requestClean(${m.id})">ì •ë¦¬ ìš”ì²­</button>`;
    }
  }

  if(m.status=="finished"){
    h+=`ğŸ”´ ì‚¬ìš© ì™„ë£Œ (${m.room}í˜¸)<br>
    <button class="clean" onclick="clearMachine(${m.id})">ì •ë¦¬ ì™„ë£Œ</button>`;
  }

  if(m.reservations.length){
    h+=`<small>ì˜ˆì•½: ${m.reservations.join(", ")}í˜¸</small>`;
    if(m.reservations.includes(myRoom))
      h+=`<br><button class="cancel" onclick="cancelReserve(${m.id})">ì˜ˆì•½ ì·¨ì†Œ</button>`;
  }

  return h+"</div>";
}

/* ================= ìë™ ì™„ë£Œ ì²˜ë¦¬ ğŸ”§ ================= */
function autoFinishCheck(){
  let changed=false;
  machines.forEach(m=>{
    if(m.status==="using" && m.endTime && Date.now()>=m.endTime){
      m.status="finished";
      changed=true;
      if(m.room===myRoom){
        alert("ğŸ”” ì‚¬ìš©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤");
      }
    }
  });
  if(changed) save();   // ğŸ”¥ í•µì‹¬
}

/* ================= ë Œë” ================= */
function render(){
  autoFinishCheck();     // ğŸ”§ ì¶”ê°€
  dashboard();
  favoritesBox.innerHTML="";
  app.innerHTML="";

  if(favorites.length){
    favoritesBox.innerHTML="<h2>â­ ì¦ê²¨ì°¾ê¸°</h2>";
    machines.filter(m=>favorites.includes(m.id))
      .forEach(m=>favoritesBox.innerHTML+=machineHTML(m));
  }

  [1,2,3].forEach(f=>{
    app.innerHTML+=`<h2>${f}ì¸µ</h2>`;
    machines.filter(m=>m.floor==f)
      .forEach(m=>app.innerHTML+=machineHTML(m));
  });
}

/* ================= ê¸°ëŠ¥ ================= */
window.toggleFav=id=>{
  favorites.includes(id)
    ? favorites=favorites.filter(f=>f!=id)
    : favorites.push(id);
  localStorage.setItem("favorites",JSON.stringify(favorites));
  render();
};

window.start=id=>{
  if(machines.some(m=>m.room==myRoom&&m.status=="using"))
    return alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤");
  let t=parseTime(prompt("ì‚¬ìš© ì‹œê°„ ì…ë ¥"));
  if(!t)return;
  let m=machines.find(x=>x.id==id);
  m.status="using";m.room=myRoom;m.endTime=Date.now()+t*60000;
  save();
};

window.extendTime=id=>{
  let t=parseTime(prompt("ì—°ì¥ ì‹œê°„ ì…ë ¥"));
  if(!t)return;
  machines.find(x=>x.id==id).endTime+=t*60000;
  save();
};

window.reserve=id=>{
  if(machines.some(m=>m.reservations.includes(myRoom)))
    return alert("ì´ë¯¸ ì˜ˆì•½ ì¤‘");
  machines.find(x=>x.id==id).reservations.push(myRoom);
  save();
};

window.cancelReserve=id=>{
  let m=machines.find(x=>x.id==id);
  m.reservations=m.reservations.filter(r=>r!=myRoom);
  save();
};

window.finish=id=>{
  machines.find(x=>x.id==id).status="finished";
  save();
};

window.clearMachine=id=>{
  let m=machines.find(x=>x.id==id);
  let next=m.reservations.shift();
  if(next && next===myRoom){
    alert("ğŸ”” ì˜ˆì•½í•œ ì„¸íƒê¸°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤");
  }
  Object.assign(m,{status:"available",room:null,endTime:null});
  save();
};

window.requestClean=id=>{
  let m=machines.find(x=>x.id==id);
  if(m.room!==myRoom){
    alert(`ğŸ“¢ ${m.room}í˜¸ì— ì •ë¦¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤`);
  }
};

/* ================= ì‹œì‘ ================= */
const dashboardEl=document.getElementById("dashboard");
const favoritesBox=document.getElementById("favorites");
const app=document.getElementById("app");

setInterval(render,1000);
render();
</script>
</body>
</html>